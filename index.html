<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <title>Dis This: Online Python Disassembler</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata|Roboto:300,400,500|Work+Sans:400,700">
    <style>
textarea,input[type=text] {
  font-family: monospace;
  font-weight: normal;
}
    </style>
    <style>

      </style>
  </head>
  <body>
    <div class="container">

    <h1>Disassemble Python code</h1>
    <label>Type Python code here:
    <br>
    <textarea id="code-textarea" rows="10" cols="120" name="function_definition"></textarea>
    </label>
    <br>
    <button id="disassemble-button" type="button" class="btn btn-primary" disabled>Disassemble!</button>
    <span id="disassemble-status">Loading Pyodide...</span>

    <table id="disassemble-output" style="margin-top: 80px; max-width:700px;" class="table table-sm">
      <thead>
        <tr><th>Line number <th>Offset <th>Opcode name <th>Opcode parameters<th>Interpretation of parameters
      <tbody id="disassemble-rows">
    </table>

    <div id="permalink-area" style="margin-top:12px; display:none;">
    <label for="permalink-input">Permalink:</label> <input type="url" id="permalink-input" style="width: 600px;">
    </div>
 
    <div style="margin-top:80px;">
    <p>Source code on <a href="https://github.com/pamelafox/dis-this" target="_blank">Github</a>. Uses Pyodide and the Python dis module.</p>
    </div>

    </div>
    <!-- Python WASM -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.19.0/full/pyodide.js"></script>
    <!-- Query params functionality-->
    <script>
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    if (code) document.getElementById('code-textarea').value = code;
    </script>
    <!-- Python disassembly-->
    <script>
    var pyodide;
    
    function disassembleCode() {
        document.getElementById("disassemble-status").innerHTML = "Disassembling...";
        const code = document.getElementById('code-textarea').value;
        document.getElementById("disassemble-rows").innerText = '';
        pyodide.runPython(`import dis; dis.dis('''${code}''')`);
        const permalink = `${window.location.origin}/?code=${encodeURIComponent(code)}`.replace(/\(/g, '%28').replace(/\)/g, '%29');
        document.getElementById("permalink-area").style.display = "block";
        document.getElementById("permalink-input").value = permalink;
    }

    function handleStdOut(output) {
        console.log(output);
        const matches = output.match(/\s*(\d+)?\s+(\d+)\s+([A-Z_]+)\s*(\d+)?\s*(\(\w+\))?/);
        if (!matches) {
          return;
        }
        document.getElementById("disassemble-status").innerHTML = "";
        const lineNo = matches[1] || '';
        const offset = matches[2];
        const opcode = matches[3];
        const param = matches[4] || '';
        const paramD = matches[5] || '';
        document.getElementById("disassemble-rows").innerHTML += `<tr><td>${lineNo}<td>${offset}<td><a href="https://docs.python.org/3/library/dis.html#opcode-${opcode}" target="_blank">${opcode}</a></td><td>${param}<td>${paramD}`;
    }

    async function main() {
      pyodide = await loadPyodide({
        indexURL : "https://cdn.jsdelivr.net/pyodide/v0.19.0/full/",
        stdout: handleStdOut,
      });
      document.getElementById("disassemble-status").innerHTML = "";
      document.getElementById("disassemble-button").removeAttribute("disabled");
      document.getElementById("disassemble-button").addEventListener("click", disassembleCode);
      code && disassembleCode();
    };

    main();
   </script>
  </body>
</html>
